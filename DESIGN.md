# Pixel Sprite Studio - Technical Design

## Data Model

### Hierarchy

```
Project
├── canvas_size: { width, height }
├── Characters[]
│   ├── name: string
│   ├── default_z_order: { part_name → z_index }
│   └── Parts[]
│       ├── name: string
│       └── States[]
│           ├── name: string
│           ├── rotation_mode: "45deg" | "22.5deg"
│           └── rotations: { angle → base64_png | null }
└── Animations[]
    ├── name: string
    ├── z_overrides: { part_name → z_index }
    └── Frames[]
        ├── duration_ms: number
        ├── z_overrides: { part_name → z_index }
        └── placed_parts[]
            ├── character: string
            ├── part: string
            ├── state: string
            ├── rotation: number (degrees)
            └── position: { x, y }
```

## Rotation System

### Supported Modes

- **45° mode**: 8 rotations (0°, 45°, 90°, 135°, 180°, 225°, 270°, 315°)
- **22.5° mode**: 16 rotations (0°, 22.5°, 45°, ... 337.5°)

### Automatic Mirroring

When importing rotations, only half need to be provided. Missing rotations are generated by horizontal mirroring:

| Provided | Generated via Mirror |
|----------|---------------------|
| 0°       | (no mirror needed)  |
| 45°      | 315°                |
| 90°      | 270°                |
| 135°     | 225°                |
| 180°     | (no mirror needed)  |

The mirror operation flips the image horizontally. For a character facing right at 45°, mirroring produces the character facing left at 315°.

### Import Convention

Users provide rotations for the "right-facing" half (0° through 180°), and the tool generates the "left-facing" half (181° through 359°) automatically.

## Z-Index Resolution

Z-index determines draw order (higher = drawn on top). The system uses a 3-tier override:

```rust
fn resolve_z_index(part: &str, frame: &Frame, anim: &Animation, char: &Character) -> i32 {
    // Frame-level override takes priority
    if let Some(z) = frame.z_overrides.get(part) {
        return *z;
    }
    // Then animation-level override
    if let Some(z) = anim.z_overrides.get(part) {
        return *z;
    }
    // Finally character default
    char.default_z_order.get(part).copied().unwrap_or(0)
}
```

### Use Cases

- **Character default**: Cape always behind torso (cape: 0, torso: 10)
- **Animation override**: In "flying" animation, cape billows in front (cape: 15)
- **Frame override**: In frame 3 of flying, cape wraps around (cape: 5)

## Reference Layer

The reference layer allows placing a guide image beneath the canvas:

- **Independent of canvas size**: Reference can be any resolution
- **Transform controls**: Position (x, y), scale (uniform), rotation (degrees)
- **Opacity**: 0-100% transparency
- **Toggle visibility**: Quick show/hide
- **Not exported**: Reference is for editing only, never included in output

## Project File Format

### File Extension

`.pss`

### Schema (v1.0)

```json
{
  "version": "1.0",
  "canvas_size": {
    "width": 64,
    "height": 64
  },
  "characters": [
    {
      "name": "hero",
      "default_z_order": {
        "cape": 0,
        "torso": 10,
        "head": 20
      },
      "parts": [
        {
          "name": "head",
          "states": [
            {
              "name": "forward",
              "rotation_mode": "45deg",
              "rotations": {
                "0": "iVBORw0KGgo...",
                "45": "iVBORw0KGgo...",
                "90": null,
                "135": "iVBORw0KGgo...",
                "180": "iVBORw0KGgo...",
                "225": null,
                "270": null,
                "315": null
              }
            }
          ]
        }
      ]
    }
  ],
  "animations": [
    {
      "name": "walk_cycle",
      "z_overrides": {},
      "frames": [
        {
          "duration_ms": 100,
          "z_overrides": {},
          "placed_parts": [
            {
              "character": "hero",
              "part": "head",
              "state": "forward",
              "rotation": 0,
              "position": { "x": 32, "y": 16 }
            },
            {
              "character": "hero",
              "part": "torso",
              "state": "neutral",
              "rotation": 0,
              "position": { "x": 32, "y": 32 }
            }
          ]
        }
      ]
    }
  ],
  "reference_layer": {
    "enabled": false,
    "image_base64": null,
    "position": { "x": 0, "y": 0 },
    "scale": 1.0,
    "rotation": 0,
    "opacity": 0.5
  }
}
```

### Notes on Base64 Encoding

- Images are stored as PNG format, base64 encoded
- `null` values indicate auto-generated rotations (mirrored from counterpart)
- On load, null rotations are computed from their mirror sources

## Export Format

### Spritesheet Output

Frames are arranged in a grid or horizontal strip:

```
┌────┬────┬────┬────┐
│ F1 │ F2 │ F3 │ F4 │  ← Single row (horizontal strip)
└────┴────┴────┴────┘

┌────┬────┬────┬────┐
│ F1 │ F2 │ F3 │ F4 │  ← Grid layout for many frames
├────┼────┼────┼────┤
│ F5 │ F6 │ F7 │ F8 │
└────┴────┴────┴────┘
```

### Metadata JSON

Exported alongside the PNG:

```json
{
  "sprite_sheet": "hero_walk.png",
  "frame_width": 64,
  "frame_height": 64,
  "frames": [
    { "x": 0, "y": 0, "duration_ms": 100 },
    { "x": 64, "y": 0, "duration_ms": 100 },
    { "x": 128, "y": 0, "duration_ms": 100 }
  ]
}
```

## UI Layout

```
┌─────────────────────────────────────────────────────────────┐
│  Menu Bar: File | Edit | View | Animation | Export          │
├──────────────┬──────────────────────────┬───────────────────┤
│              │                          │                   │
│  Asset       │       Canvas             │    Inspector      │
│  Browser     │                          │                   │
│              │   ┌──────────────────┐   │  - Selection      │
│  Characters  │   │                  │   │  - Position       │
│   └─ Parts   │   │    [sprite]      │   │  - Rotation       │
│      └─States│   │                  │   │  - State          │
│              │   └──────────────────┘   │  - Z-Index        │
│              │                          │                   │
├──────────────┴──────────────────────────┴───────────────────┤
│  Timeline                                                    │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐         │
│  │  1  │  2  │  3  │  4  │  5  │  6  │  7  │  8  │  ▶ ⏸ ⏹  │
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘         │
└─────────────────────────────────────────────────────────────┘
```

## Technology Stack

- **Bevy 0.15** - Game engine for rendering and systems
- **bevy_egui** - Immediate mode UI
- **serde / serde_json** - Serialization
- **base64** - Image encoding
- **image** - PNG processing, mirroring operations
- **rfd** - Native file dialogs
